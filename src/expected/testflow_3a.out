-- SET search_path TO test;
truncate torder;
truncate tstack;
truncate tmvt;
truncate towner;
SELECT setval('tstack_id_seq',1,false);
 setval 
--------
      1
(1 row)

copy torder from '/home/olivier/ob92/src/sql/torder_test_10000.sql';
copy towner from '/home/olivier/ob92/src/sql/towner_test_10000.sql';
truncate tstack;
SELECT setval('tstack_id_seq',10000,true);
 setval 
--------
  10000
(1 row)

select * from fsubmitquote(1,'own82','qlt22','qlt23');select * from fproducemvt();
  id   | diag 
-------+------
 10001 |    0
(1 row)

                  ord                   | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err |                                                       json                                                       
----------------------------------------+----------+----------+-------+----------+----------+-----+------------------------------------------------------------------------------------------------------------------
 (141,10001,72,10001,1,qlt22,1,qlt23,1) |    67432 |    30183 | 30183 |    67432 |    30183 |   0 | {"qtt_requ":67432,"qtt_prov":30183,"qtt":30183,"qtt_reci":67432,"qtt_give":30183,"paths":[                      +
                                        |          |          |       |          |          |     | [{"type":2, "id":8928, "oid":8928, "own":72, "qtt_requ":49263, "qtt_prov":87732, "qtt":87732, "flowr":53752},   +
                                        |          |          |       |          |          |     | {"type":1, "id":515, "oid":515, "own":69, "qtt_requ":53751, "qtt_prov":67432, "qtt":67432, "flowr":67432},      +
                                        |          |          |       |          |          |     | {"type":141, "id":10001, "oid":10001, "own":72, "qtt_requ":67432, "qtt_prov":30183, "qtt":30183, "flowr":30183}]+
                                        |          |          |       |          |          |     | ]}
(1 row)

select * from fsubmitbarter(1,'own82',NULL,'qlt22',67432,'qlt23',30183,30183);select * from fproducemvt();
  id   | diag 
-------+------
 10002 |    0
(1 row)

                       ord                        | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err | json 
--------------------------------------------------+----------+----------+-------+----------+----------+-----+------
 (1,10002,72,10002,67432,qlt22,30183,qlt23,30183) |    67432 |    30183 | 30183 |    67432 |    30183 |   0 | 
(1 row)

select xid,own_src,own_dst,qtt,nat from tmvt order by id desc limit 3;
  xid  | own_src | own_dst |  qtt  |  nat  
-------+---------+---------+-------+-------
   515 | own91   | own82   | 67432 | qlt22
  8928 | own82   | own91   | 53752 | qlt53
 10002 | own82   | own82   | 30183 | qlt23
(3 rows)

select * from fsubmitquote(1,'own82','qlt22','qlt23');select * from fproducemvt(); 
  id   | diag 
-------+------
 10003 |    0
(1 row)

                  ord                   | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err |                                                       json                                                       
----------------------------------------+----------+----------+-------+----------+----------+-----+------------------------------------------------------------------------------------------------------------------
 (141,10003,72,10003,1,qlt22,1,qlt23,1) |    61017 |    45277 | 45276 |    61017 |    45276 |   0 | {"qtt_requ":61017,"qtt_prov":45277,"qtt":45276,"qtt_reci":61017,"qtt_give":45276,"paths":[                      +
                                        |          |          |       |          |          |     | [{"type":2, "id":3288, "oid":3288, "own":34, "qtt_requ":45276, "qtt_prov":61017, "qtt":61017, "flowr":61017},   +
                                        |          |          |       |          |          |     | {"type":141, "id":10003, "oid":10003, "own":72, "qtt_requ":61017, "qtt_prov":45276, "qtt":45276, "flowr":45276}]+
                                        |          |          |       |          |          |     | ]}
(1 row)

select * from fsubmitquote(1,'own82','qlt22',61017,'qlt23',45277);select * from fproducemvt(); 
  id   | diag 
-------+------
 10004 |    0
(1 row)

                        ord                         | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err |                                                       json                                                       
----------------------------------------------------+----------+----------+-------+----------+----------+-----+------------------------------------------------------------------------------------------------------------------
 (129,10004,72,10004,61017,qlt22,45277,qlt23,45277) |    61017 |    45277 | 45276 |    61017 |    45276 |   0 | {"qtt_requ":61017,"qtt_prov":45277,"qtt":45276,"qtt_reci":61017,"qtt_give":45276,"paths":[                      +
                                                    |          |          |       |          |          |     | [{"type":2, "id":3288, "oid":3288, "own":34, "qtt_requ":45276, "qtt_prov":61017, "qtt":61017, "flowr":61017},   +
                                                    |          |          |       |          |          |     | {"type":129, "id":10004, "oid":10004, "own":72, "qtt_requ":61017, "qtt_prov":45277, "qtt":45277, "flowr":45276}]+
                                                    |          |          |       |          |          |     | ]}
(1 row)

-- select * from fsubmitbarter(1,'own82',NULL,'qlt22',61017,'qlt23',45277,45276);select * from fproducemvt();
-- select xid,own_src,own_dst,qtt,nat from tmvt order by id desc limit 2;
select * from fsubmitquote(1,'own82','qlt22',60000,'qlt23',45276);select * from fproducemvt(); 
  id   | diag 
-------+------
 10005 |    0
(1 row)

                        ord                         | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err |                                                       json                                                       
----------------------------------------------------+----------+----------+-------+----------+----------+-----+------------------------------------------------------------------------------------------------------------------
 (129,10005,72,10005,60000,qlt22,45276,qlt23,45276) |    60000 |    45276 | 45276 |    60506 |    45276 |   0 | {"qtt_requ":60000,"qtt_prov":45276,"qtt":45276,"qtt_reci":60506,"qtt_give":45276,"paths":[                      +
                                                    |          |          |       |          |          |     | [{"type":2, "id":3288, "oid":3288, "own":34, "qtt_requ":45276, "qtt_prov":61017, "qtt":61017, "flowr":60506},   +
                                                    |          |          |       |          |          |     | {"type":129, "id":10005, "oid":10005, "own":72, "qtt_requ":60000, "qtt_prov":45276, "qtt":45276, "flowr":45276}]+
                                                    |          |          |       |          |          |     | ]}
(1 row)

select * from fsubmitbarter(1,'own82',NULL,'qlt22',60000,'qlt23',45276);select * from fproducemvt();
  id   | diag 
-------+------
 10006 |    0
(1 row)

                       ord                        | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err | json 
--------------------------------------------------+----------+----------+-------+----------+----------+-----+------
 (1,10006,72,10006,60000,qlt22,45276,qlt23,45276) |    60000 |    45276 | 45276 |    60506 |    45276 |   0 | 
(1 row)

select xid,own_src,own_dst,qtt,nat from tmvt order by id desc limit 2;
  xid  | own_src | own_dst |  qtt  |  nat  
-------+---------+---------+-------+-------
  3288 | own16   | own82   | 60506 | qlt22
 10006 | own82   | own16   | 45276 | qlt23
(2 rows)

select * from fsubmitquote(1,'own82','qlt2',60000,'qlt23',45276);select * from fproducemvt();
  id   | diag 
-------+------
 10007 |    0
(1 row)

                        ord                        | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err |                                                       json                                                        
---------------------------------------------------+----------+----------+-------+----------+----------+-----+-------------------------------------------------------------------------------------------------------------------
 (129,10007,72,10007,60000,qlt2,45276,qlt23,45276) |    60000 |    45276 | 45276 |    82755 |    45276 |   0 | {"qtt_requ":60000,"qtt_prov":45276,"qtt":45276,"qtt_reci":82755,"qtt_give":45276,"paths":[                       +
                                                   |          |          |       |          |          |     | [{"type":2, "id":4352, "oid":4352, "own":36, "qtt_requ":2313, "qtt_prov":43484, "qtt":43484, "flowr":43484},     +
                                                   |          |          |       |          |          |     | {"type":1, "id":5, "oid":5, "own":5, "qtt_requ":45499, "qtt_prov":45464, "qtt":45464, "flowr":17954},            +
                                                   |          |          |       |          |          |     | {"type":129, "id":10007, "oid":10007, "own":72, "qtt_requ":60000, "qtt_prov":45276, "qtt":45276, "flowr":5598}], +
                                                   |          |          |       |          |          |     | [{"type":2, "id":1046, "oid":1046, "own":78, "qtt_requ":2318, "qtt_prov":11725, "qtt":11725, "flowr":11725},     +
                                                   |          |          |       |          |          |     | {"type":1, "id":345, "oid":345, "own":79, "qtt_requ":43486, "qtt_prov":31371, "qtt":31371, "flowr":6035},        +
                                                   |          |          |       |          |          |     | {"type":129, "id":10007, "oid":10007, "own":72, "qtt_requ":60000, "qtt_prov":45276, "qtt":39678, "flowr":3249}], +
                                                   |          |          |       |          |          |     | [{"type":1, "id":2361, "oid":2361, "own":2, "qtt_requ":59716, "qtt_prov":98494, "qtt":98494, "flowr":30997},     +
                                                   |          |          |       |          |          |     | {"type":1, "id":337, "oid":337, "own":44, "qtt_requ":25168, "qtt_prov":37776, "qtt":37776, "flowr":37776},       +
                                                   |          |          |       |          |          |     | {"type":129, "id":10007, "oid":10007, "own":72, "qtt_requ":60000, "qtt_prov":45276, "qtt":36429, "flowr":23145}],+
                                                   |          |          |       |          |          |     | [{"type":1, "id":2361, "oid":2361, "own":2, "qtt_requ":59716, "qtt_prov":98494, "qtt":67497, "flowr":18376},     +
                                                   |          |          |       |          |          |     | {"type":1, "id":321, "oid":321, "own":48, "qtt_requ":53964, "qtt_prov":73494, "qtt":73494, "flowr":20990},       +
                                                   |          |          |       |          |          |     | {"type":129, "id":10007, "oid":10007, "own":72, "qtt_requ":60000, "qtt_prov":45276, "qtt":13284, "flowr":13284}] +
                                                   |          |          |       |          |          |     | ]}
(1 row)

select * from fsubmitbarter(1,'own82',NULL,'qlt2',60000,'qlt23',45276);select * from fproducemvt();
  id   | diag 
-------+------
 10008 |    0
(1 row)

                       ord                       | qtt_requ | qtt_prov |  qtt  | qtt_reci | qtt_give | err | json 
-------------------------------------------------+----------+----------+-------+----------+----------+-----+------
 (1,10008,72,10008,60000,qlt2,45276,qlt23,45276) |    60000 |    45276 | 45276 |    82755 |    45276 |   0 | 
(1 row)

select id,nbt,nbc,xid,own_src,own_dst,qtt,nat from tmvt order by id desc limit 12;
 id | nbt | nbc |  xid  | own_src | own_dst |  qtt  |  nat  
----+-----+-----+-------+---------+---------+-------+-------
 30 |  12 |   3 |   321 | own35   | own82   | 20990 | qlt2
 29 |  12 |   3 |  2361 | own66   | own35   | 18376 | qlt72
 28 |  12 |   3 | 10008 | own82   | own66   | 13284 | qlt23
 27 |  12 |   3 |   337 | own37   | own82   | 37776 | qlt2
 26 |  12 |   3 |  2361 | own66   | own37   | 30997 | qlt72
 25 |  12 |   3 | 10008 | own82   | own66   | 23145 | qlt23
 24 |  12 |   3 |   345 | own56   | own82   |  6035 | qlt2
 23 |  12 |   3 |  1046 | own43   | own56   | 11725 | qlt92
 22 |  12 |   3 | 10008 | own82   | own43   |  3249 | qlt23
 21 |  12 |   3 |     5 | own3    | own82   | 17954 | qlt2
 20 |  12 |   3 |  4352 | own75   | own3    | 43484 | qlt89
 19 |  12 |   3 | 10008 | own82   | own75   |  5598 | qlt23
(12 rows)

select sum(qtt) from tmvt where own_src='own82' and nat='qlt23' and id>18;
  sum  
-------
 45276
(1 row)

select sum(qtt) from tmvt where own_dst='own82' and nat='qlt2' and id>18;
  sum  
-------
 82755
(1 row)

